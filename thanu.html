<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Accurate Location (Best Fix, No Server)</title>
<style>
  body { margin: 24px; }
  .card { max-width: 720px; margin: 0 auto; padding: 20px; border: 1px solid #ddd; border-radius: 12px; }
  h1 { margin: 0 0 12px; font-size: 1.3rem; }
  .row { display: grid; grid-template-columns: 160px 1fr; gap: 8px; align-items: center; margin: 6px 0; }
  .mono { font-family: ui-monospace, Menlo, Consolas, monospace; }
  .btn { cursor: pointer; padding: 10px 14px; border-radius: 10px; border: 1px solid #ccc; background: #fff; }
  .btn[disabled] { opacity: .55; cursor: not-allowed; }
  .actions { display:flex; gap:8px; flex-wrap:wrap; margin: 12px 0; }
  #status { margin: 10px 0; }
  .ok { color:#0a7a00 } .warn{ color:#b06000 } .err{ color:#b00020 }
  .hint { font-size: .9rem; color:#555; }
</style>
</head>
<body>
<div class="card">
  <h1>Accurate Location (Best Fix)</h1>
  <div class="hint" id="secureHint"></div>

  <div class="actions">
    <button id="btnBest" class="btn">Get Best Fix (≈25s)</button>
    <button id="btnOnce" class="btn">One-shot</button>
    <button id="btnTrack" class="btn">Start Live Track</button>
    <button id="btnStop" class="btn" disabled>Stop</button>
  </div>

  <div id="status" class="warn">Waiting…</div>

  <div class="row"><div>Latitude</div>  <div id="lat" class="mono">—</div></div>
  <div class="row"><div>Longitude</div> <div id="lon" class="mono">—</div></div>
  <div class="row"><div>Best accuracy (m)</div> <div id="acc" class="mono">—</div></div>
  <div class="row"><div>Samples collected</div> <div id="samples" class="mono">0</div></div>
  <div class="row"><div>Time to fix</div> <div id="elapsed" class="mono">—</div></div>
  <div class="row"><div>Timestamp</div> <div id="ts" class="mono">—</div></div>

  <p><a id="maps" href="#" target="_blank" rel="noopener">Open in Google Maps</a></p>

  <details>
    <summary>Tips for accuracy</summary>
    <ul>
      <li>Open this page on <b>HTTPS or localhost</b> (geolocation is blocked on <span class="mono">file://</span>).</li>
      <li><b>Use a phone outdoors/near a window.</b> Desktops usually give coarse IP location.</li>
      <li><b>Android:</b> Settings → Location → <i>Improve accuracy / Wi-Fi & Bluetooth scanning</i> ON. Set Mode to <i>High accuracy</i>.</li>
      <li><b>iOS (Safari/Chrome):</b> Settings → Privacy & Security → Location Services → your browser → <i>While Using the App</i> and <i>Precise Location</i> ON.</li>
      <li>Let it run ~10–25s so GPS can lock; the button above picks the best reading automatically.</li>
    </ul>
  </details>
</div>

<script>
const $ = s => document.querySelector(s);
const fmt = (n, d=6) => (Number.isFinite(n) ? n.toFixed(d) : "—");

(function secureHint(){
  const ok = window.isSecureContext || ["localhost","127.0.0.1","::1"].includes(location.hostname);
  $("#secureHint").textContent = ok
    ? "Secure context ✓"
    : "Not secure context ✗ (use HTTPS or localhost)";
})();

function setStatus(msg, cls=""){ const el=$("#status"); el.className=cls; el.textContent=msg; }

function showPosition(pos, {samples, bestAcc, elapsedMs} = {}) {
  const c = pos.coords;
  $("#lat").textContent = fmt(c.latitude);
  $("#lon").textContent = fmt(c.longitude);
  $("#acc").textContent = c.accuracy ? c.accuracy.toFixed(1) : (bestAcc ?? "—");
  $("#samples").textContent = samples ?? $("#samples").textContent;
  $("#elapsed").textContent = elapsedMs ? (Math.round(elapsedMs/1000)+"s") : $("#elapsed").textContent;
  $("#ts").textContent = new Date(pos.timestamp).toLocaleString();
  $("#maps").href = `https://maps.google.com/?q=${c.latitude},${c.longitude}`;
}

function onError(err){
  const map = {1:"Permission denied",2:"Position unavailable",3:"Timeout"};
  setStatus(`${map[err.code] || "Error"}${err.message ? ": "+err.message : ""}`, "err");
}

// Collect multiple readings and choose the BEST (lowest accuracy value)
function getBestFix({maxMs=25000, targetAcc=15} = {}) {
  return new Promise((resolve, reject) => {
    if (!("geolocation" in navigator)) return reject(new Error("Geolocation not supported"));
    const start = Date.now();
    let best = null, count = 0, id = null;

    id = navigator.geolocation.watchPosition(
      p => {
        count++;
        if (!best || (p.coords.accuracy || 1e9) < (best.coords.accuracy || 1e9)) best = p;
        showPosition(p, {samples: count});
        setStatus(`Collecting… (${count})`, "warn");

        const acc = p.coords.accuracy || 1e9;
        const elapsed = Date.now() - start;
        if (acc <= targetAcc || elapsed >= maxMs) {
          navigator.geolocation.clearWatch(id);
          showPosition(best, {samples: count, elapsedMs: elapsed});
          setStatus(`Best of ${count} readings in ${Math.round(elapsed/1000)}s`, "ok");
          resolve(best);
        }
      },
      e => { if (id) navigator.geolocation.clearWatch(id); reject(e); },
      { enableHighAccuracy: true, maximumAge: 0, timeout: 15000 }
    );
  });
}

// Buttons
$("#btnBest").onclick = async () => {
  setStatus("Finding best fix…", "warn");
  try { await getBestFix(); } catch(e){ onError(e); }
};

$("#btnOnce").onclick = () => {
  if (!("geolocation" in navigator)) return onError(new Error("Geolocation not supported"));
  setStatus("Fetching one reading…", "warn");
  navigator.geolocation.getCurrentPosition(
    p => { showPosition(p); setStatus("One-shot location received.", "ok"); },
    onError,
    { enableHighAccuracy: true, maximumAge: 0, timeout: 15000 }
  );
};

let watchId = null;
$("#btnTrack").onclick = () => {
  if (watchId !== null) return;
  if (!("geolocation" in navigator)) return onError(new Error("Geolocation not supported"));
  setStatus("Live tracking…", "ok");
  watchId = navigator.geolocation.watchPosition(
    p => showPosition(p),
    onError,
    { enableHighAccuracy: true, maximumAge: 0, timeout: 15000 }
  );
  $("#btnStop").disabled = false;
};
$("#btnStop").onclick = () => {
  if (watchId !== null) {
    navigator.geolocation.clearWatch(watchId);
    watchId = null;
    setStatus("Stopped.", "warn");
  }
  $("#btnStop").disabled = true;
};
</script>
</body>
</html>
